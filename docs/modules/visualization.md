# Visualization

## High resolution image of pixel level factorization results

**`draw-pixel-factors` visualizes the results of `pixel-decode`**

```bash
punkst draw-pixel-factors --in ${path}/pixel.decode --in-color ${path}/color.rgb.tsv --out ${path}/pixel.png --scale 1 --xmin ${xmin} --xmax ${xmax} --ymin ${ymin} --ymax ${ymax}
```

`--in` specifies the prefix of the input data and index files created by `pixel-decode`. The tool will look for `${in}.bin` (or `${in}.tsv`) and `${in}.index`.

`--binary` indicates the input data is in binary format (if you used `punkst pixel-decode` with `--output-binary`)

`--out` specifies the output png file.

`--in-color` specifies a tsv file with the colors for each factor. The first three columns will be interpreted as R, G, B values in the range $0-255$. The valid lines will be assigned to factors in the order they appear in this file. An example color table can be found in `punkst/ext/py/cmap.48.tsv`.

`--xmin`, `--xmax`, `--ymin`, `--ymax` specify the range of the coordinates. If your data is generated by `punkst pixel-decode` and you want to visualize the whole area, these parameters are unnecessary.

`--scale` (default 1) scales input coordinates to pixels in the output image. `int((x-xmin)/scale)` equals the horizontal pixel coordinate in the image. Since coordinates are normally in micrometer and the analysis resolution is typically 0.5 or 1, `--scale 1` (default) is usually a good choice. For Visium HD data where the data resolution is 2um, use `--scale 2`.

`--min-prob` (default: 1e-3) Minimum probability to consider a pixel.

`--top-only` Use only the top predicted factor per pixel.

If your specified `--transform` in `topic-model`, one way to create the color table is to use the helper python script
```bash
python punkst/ext/py/color_helper.py --input ${path}/prefix.results.tsv --output ${path}/color
```

**Visualize selected factors**

Alternatively, you can specify a few factors and their corresponding colors directly:

`--channel-list` A list of factors to visualize

`--color-list` A list of colors in hex code (#RRGGBB).

**Denoise**

When `--top-only` is used, you could optionally smooth out isolated noisy pixels. This is heuristic, and may only be meaningful when you projected categorical cell types.

`--island-smooth` The number of iterations to remove isolated noisy pixels different from most of its neighbors. One or two iterations is recommended.

`--fill-empty-islands` Fill empty pixels surrounded by consistent neighbors (only activated when --island-smooth is set).

## HTML report for factor weights and top genes

**`factor_report.py` generates HTML reports summarizing factor characteristics and top genes**

The script generates an interactive HTML report (`${output_pref}.factor.info.html`) and a TSV summary (`${output_pref}.factor.info.tsv`) containing factor weights, top differentially expressed genes, and visualization colors.

```bash
python ext/py/factor_report.py --de ${path}/de_bulk.tsv --pseudobulk ${path}/pseudobulk.tsv --color_table ${path}/color.rgb.tsv --output_pref ${path}/report
```

`--de` specifies the differential expression results file from [`de-chisq`](./de.md)

`--de_neighbor` optionally specifies a [`de-chisq`](./de.md) neighbor-output file (e.g. `${out}.1vsNeighbors.tsv`) to add a column displaying high specific top genes.

`--pseudobulk` specifies the pseudobulk count table.

`--color_table` specifies the RGB color table for factors. This probably should be the same file as that used for `punkst draw-pixel-factors`.

`--output_pref` specifies the output prefix for generated files.

`--feature_label` specifies the column name for features (default: "Feature").

`--n_top_gene` maximum number of top genes to include in report (default: 20).

`--min_top_gene` minimum number of top genes to show per factor (default: 10).

`--max_pval` maximum p-value threshold for significant genes (default: 0.001).

`--min_fc` minimum fold change threshold for significant genes (default: 1.5).

`--annotation` optional file with factor annotations to display instead of the factor IDs. It is a tsv file where the first column contains factor IDs as appear in the header of the pseudobulk table, and the second column contains the annotation.

`--anchor` optional file with anchor genes chosen to represent each factor. It is a tsv file where the first column contains factor IDs as appear in the header of the pseudobulk table, and the second column contains the anchor gene names (separated by things other than tabs).
