# Differential expression tests

- `punkst de-chisq`: Chi-squared DE on pseudobulk matrices.
- `punkst multi-conditional-de-pixel`: Multi-sample (pairwise), cell type-specific DE using pixel-level annotations.

## de-chisq

`de-chisq` runs a Chi-squared test on a pseudobulk matrix.
Provide one input for a 1-vs-rest test per factor, or two inputs for a pairwise comparison of each factor between datasets.

1-vs-rest per factor:
```bash
punkst de-chisq --input pseudobulk.tsv --out de.tsv --min-fc 1.5 --max-pval 1e-3
```

Pairwise comparison between two pseudobulk matrices:
```bash
punkst de-chisq --input sampleA.pseudobulk.tsv sampleB.pseudobulk.tsv \
  --out de.pair.tsv --min-fc 1.5 --max-pval 1e-4
```
### Input Format

The input is a TSV file where the first row must be a header including an arbitrary label for the feature name column (e.g. "Gene") followed by K factor / cell type names.
Then each row starts with the gene name followed by counts of that gene for each factor.

Such matrices will be generated by `punkst topic-model` (`lda4hex`) and `pixel-decode`.

For pairwise input, the two matrices should have matching factor columns. Feature names are intersected between the two files.

### Required Parameters

`--input` - Input TSV file. Provide one file for 1-vs-rest tests, or two files for pairwise comparison.
`--out` - Output TSV file.

### Optional Parameters

`--min-count-per-feature` - Minimum total count for a feature to be considered. Default: 100.

`--max-pval` - Max p-value for output. Default: 1e-3.

`--min-fc` - Minimum fold change. Default: 1.5.

`--min-count` - Minimum observed count for a (feature, factor) pair to be tested. Default: 10.

`--pseudocount` - Pseudocount added to each cell for the Chi-squared test. Default: 0.5.

`--threads` - Number of threads. Default: 1. (For consistency, multi-threading is not necessary here)

### Output

Single input output columns:

`Feature`, `Factor`, `Chi2`, `FoldChange`, `log10pval`

Two-input output columns:

`Feature`, `Factor`, `Chi2`, `FoldChange`, `log10pval`, `Count1`, `Count2`

Rows are sorted by factor (ascending) and Chi2 (descending) within each factor.

## multi-conditional-de-pixel

`multi-conditional-de-pixel` joins pixel-level annotation results with the original transcript data on the fly and performs cell-type-specific DE between pairs of datasets. It aggregates transcripts into grid units of size `--grid-size` stratified by pixel level cell type assignments then runs pairwise tests across datasets for each cell type using a Binomial model. The p-values are computed using robust sandwich estimators of the standard errors of the estimated effect sizes.

$X^{(k)}_{im} \sim$ Binom $(N^{(k)}_{im}, \pi^{(k)}_{im})$ for cell type $k$, bin $i$ and gene $m$, where both $X$ and $N$ are soft-aggregated counts from pixel level cell type assignments.

logit $(\pi^{(k)}_{im}) = a^{(k)}_m + y_i b^{(k)}_m$, where $y_i$ is a binary indicator for the dataset (0/1). The null hypothesis is $b^{(k)}_m = 0$.

Note: the intended use is when the cell type model is from external sources (e.g. apply `pixel-decode` with a reference-based cell type pseudobulk matrix). The interpretation is tricky if the cell types are learned from the same datasets. Either way, this is only a data exploration tool and we do not claim that it is statistically rigorous.

```bash
punkst multi-conditional-de-pixel \
  --anno sampleA/pixel sampleB/pixel --binary \
  --pts sampleA/transcripts.tiled sampleB/transcripts.tiled \
  --labels sampleA sampleB \
  --K 12 --features features.tsv \
  --grid-size 20 --min-count 10 \
  --icol-x 0 --icol-y 1 --icol-feature 2 --icol-val 3 \
  --out de/pixel_de --threads 8
```

### Required Parameters

`--anno` - Prefixes of pixel annotation files (from `punkst pixel-decode`). For each prefix, the tool expects `<prefix>.tsv` (or `<prefix>.bin` if `--binary`) and `<prefix>.index`.

`--anno-data` / `--anno-index` - Alternative to `--anno`. Provide explicit data and index files (same count for each).

`--pts` - Prefixes of transcript data files (from `punkst pts2tiles`). For each prefix, the tool expects `<prefix>.tsv` and `<prefix>.index`.

`--K` - Number of factors in the annotation files.

`--features` - A list of features to test, one feature name per line (lines starting with `#` are ignored).

`--grid-size` - Grid size used to aggregate transcripts into units.

`--icol-x`, `--icol-y`, `--icol-feature`, `--icol-val` - Column indices for X/Y coordinates, feature name, and count in the transcript files (0-based).

`--out` - Output prefix.

Annotation and transcript tiles must use the same tile size for each dataset pair (this is guaranteed if the pixel level decoding results are generated from the corresponding transcript tiles by `punkst pixel-decode`).

### Optional Parameters

`--labels` - Labels for datasets used in pairwise output; defaults to `0..N-1`.

`--binary` - Indicates the annotation data files are binary (`.bin`).

`--min-count-per-feature` - Minimum total count (in each pairwise comparison) for a feature to be considered. Default: 100.

`--max-pval` - Max p-value for output. Default: 1e-3.

`--min-or` - Minimum odds ratio for output (bidirectional, so OR$>x$ and OR$<1/x$ are kept). Default: 1.2.

`--min-count` - Minimum observed cell-type-specific count for a unit to be included. Default: 10.

`--threads` - Number of threads. Default: 1. Almost the entire runtime is spent in data loading, so multi-threading is very useful for large datasets since tiles of data are loaded simultaneously.

`--debug` - Enable debug logging.

### Output Files

Given `--out PREFIX`, the command writes:

`PREFIX.marginal.tsv` - Per cell type tests between dataset pairs.

`Data0`/`Data1` columns correspond to the dataset labels provided via `--labels` (or numeric indices if omitted).

The first column `Slice` indicates the cell type index (0-based, as in the pixel level result files).

The following pair of files are from essentially the same tests as above but transformed the effect sizes to global (across cell types) and deviation from the global shift in each cell type.

`PREFIX.global.tsv` - Global test per feature and dataset pair.

`PREFIX.deviation.tsv` - Cell type specific shift between dataset pairs deviaiting from the global shift.

Auxiliary files:

`PREFIX.nobs.tsv` - The number of units and the total number of pixels used for each cell type by dataset.

`PREFIX.sums.tsv` - The total feature counts by dataset (this includes only the units that passed the `--min-count` filter for the corresponding cell type).
